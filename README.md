# Last value price service

Service for keeping track of the last price for financial instruments.
Producers will use the service to publish prices and consumers will use it to obtain them.

## Domain

This section describes domain objects.

### Price data

The price data consists of records with the following fields:
* `id`: a string field to indicate which instrument this price refers to.
* `asOf`: a date time field to indicate when the price was determined.
* `payload`: the price data itself, which is a flexible data structure.

### Price producer

Producers should be able to provide prices in batch runs.
The sequence of uploading a batch run is as follows:
1. The producer indicates that a batch run is started
2. The producer uploads the records in the batch run in multiple chunks of 1000 records.
3. The producer completes or cancels the `batch run`.

### Batch run

Batch run is a session of uploading chunks.

### Price consumer

Consumers can request the last price record for a given id.
The last value is determined by the asOf time, as set by the producer.
On completion, all prices in a batch run should be made available at the same time.
Batch runs which are cancelled can be discarded.

## Nonfunctional requirements.

The service should be resilient against producers which call the service methods in an incorrect order,
or clients which call the service while a batch is being processed.

## Performance tests

Several scenarious were implemented to test system perfomance in terms of request/responce latency.

### Start Upload and Complete batch run

This test is implemeted in `StartUploadCompletePerformanceTest` class.

#### START_BATCH_HISTOGRAM

```
        Value     Percentile TotalCount 1/(1-Percentile)

       61.151 0.000000000000          1           1.00
       71.999 0.100000000000       3021           1.11
       76.287 0.200000000000       6022           1.25
       79.295 0.300000000000       9034           1.43
       81.727 0.400000000000      12070           1.67
       84.031 0.500000000000      15029           2.00
       85.247 0.550000000000      16507           2.22
       86.591 0.600000000000      18011           2.50
       88.255 0.650000000000      19535           2.86
       90.111 0.700000000000      21039           3.33
       92.415 0.750000000000      22509           4.00
       93.823 0.775000000000      23252           4.44
       95.487 0.800000000000      24008           5.00
       97.407 0.825000000000      24769           5.71
       99.647 0.850000000000      25513           6.67
      102.463 0.875000000000      26268           8.00
      104.383 0.887500000000      26634           8.89
      106.623 0.900000000000      27011          10.00
      109.311 0.912500000000      27376          11.43
      112.703 0.925000000000      27750          13.33
      118.399 0.937500000000      28126          16.00
      121.599 0.943750000000      28314          17.78
      126.207 0.950000000000      28501          20.00
      131.583 0.956250000000      28688          22.86
      137.599 0.962500000000      28878          26.67
      145.791 0.968750000000      29068          32.00
      149.887 0.971875000000      29158          35.56
      154.495 0.975000000000      29253          40.00
      160.511 0.978125000000      29344          45.71
      166.911 0.981250000000      29438          53.33
      173.695 0.984375000000      29532          64.00
      178.047 0.985937500000      29579          71.11
      184.191 0.987500000000      29625          80.00
      189.567 0.989062500000      29672          91.43
      199.807 0.990625000000      29720         106.67
      207.359 0.992187500000      29766         128.00
      213.247 0.992968750000      29790         142.22
      222.591 0.993750000000      29813         160.00
      229.631 0.994531250000      29836         182.86
      244.351 0.995312500000      29860         213.33
      258.431 0.996093750000      29883         256.00
      266.239 0.996484375000      29895         284.44
      275.199 0.996875000000      29907         320.00
      284.927 0.997265625000      29918         365.71
      303.871 0.997656250000      29930         426.67
      324.863 0.998046875000      29943         512.00
      335.359 0.998242187500      29948         568.89
      346.623 0.998437500000      29954         640.00
      360.191 0.998632812500      29959         731.43
      378.879 0.998828125000      29965         853.33
      413.951 0.999023437500      29971        1024.00
      460.543 0.999121093750      29974        1137.78
      478.207 0.999218750000      29977        1280.00
      487.167 0.999316406250      29980        1462.86
      547.327 0.999414062500      29983        1706.67
      574.463 0.999511718750      29986        2048.00
      593.407 0.999560546875      29987        2275.56
      629.247 0.999609375000      29989        2560.00
      649.215 0.999658203125      29990        2925.71
      689.151 0.999707031250      29992        3413.33
      710.143 0.999755859375      29993        4096.00
      805.887 0.999780273438      29994        4551.11
      818.687 0.999804687500      29995        5120.00
      818.687 0.999829101563      29995        5851.43
     1142.783 0.999853515625      29996        6826.67
     1373.183 0.999877929688      29997        8192.00
     1373.183 0.999890136719      29997        9102.22
     1645.567 0.999902343750      29998       10240.00
     1645.567 0.999914550781      29998       11702.86
     1645.567 0.999926757813      29998       13653.33
     9658.367 0.999938964844      29999       16384.00
     9658.367 0.999945068359      29999       18204.44
     9658.367 0.999951171875      29999       20480.00
     9658.367 0.999957275391      29999       23405.71
     9658.367 0.999963378906      29999       27306.67
    11468.799 0.999969482422      30000       32768.00
    11468.799 1.000000000000      30000
 #[Mean    =       90.329, StdDeviation   =       90.988]
 #[Max     =    11468.799, Total count    =        30000]
 #[Buckets =           24, SubBuckets     =         2048]
```

#### UPLOAD_CHUNK_HISTOGRAM

```
       Value     Percentile TotalCount 1/(1-Percentile)

     341.247 0.000000000000          1           1.00
     356.607 0.100000000000       3114           1.11
     360.959 0.200000000000       6162           1.25
     364.287 0.300000000000       9289           1.43
     366.847 0.400000000000      12107           1.67
     369.663 0.500000000000      15182           2.00
     370.943 0.550000000000      16504           2.22
     372.735 0.600000000000      18198           2.50
     374.527 0.650000000000      19634           2.86
     376.575 0.700000000000      21081           3.33
     379.391 0.750000000000      22560           4.00
     381.439 0.775000000000      23333           4.44
     383.487 0.800000000000      24025           5.00
     386.303 0.825000000000      24788           5.71
     389.631 0.850000000000      25532           6.67
     394.239 0.875000000000      26263           8.00
     397.311 0.887500000000      26630           8.89
     401.407 0.900000000000      27017          10.00
     407.551 0.912500000000      27395          11.43
     415.743 0.925000000000      27752          13.33
     428.287 0.937500000000      28127          16.00
     436.991 0.943750000000      28314          17.78
     447.999 0.950000000000      28507          20.00
     462.591 0.956250000000      28689          22.86
     479.999 0.962500000000      28875          26.67
     502.015 0.968750000000      29065          32.00
     513.279 0.971875000000      29157          35.56
     525.823 0.975000000000      29254          40.00
     541.695 0.978125000000      29350          45.71
     565.759 0.981250000000      29439          53.33
     595.967 0.984375000000      29532          64.00
     610.303 0.985937500000      29579          71.11
     623.615 0.987500000000      29625          80.00
     641.023 0.989062500000      29674          91.43
     678.399 0.990625000000      29719         106.67
     705.023 0.992187500000      29766         128.00
     726.527 0.992968750000      29793         142.22
     745.983 0.993750000000      29813         160.00
     769.535 0.994531250000      29836         182.86
     795.135 0.995312500000      29860         213.33
     820.735 0.996093750000      29883         256.00
     838.655 0.996484375000      29895         284.44
     847.359 0.996875000000      29907         320.00
     858.623 0.997265625000      29918         365.71
     885.759 0.997656250000      29930         426.67
     918.015 0.998046875000      29942         512.00
     942.079 0.998242187500      29948         568.89
     990.207 0.998437500000      29954         640.00
    1016.831 0.998632812500      29959         731.43
    1080.319 0.998828125000      29965         853.33
    1127.423 0.999023437500      29971        1024.00
    1169.407 0.999121093750      29974        1137.78
    1255.423 0.999218750000      29977        1280.00
    1296.383 0.999316406250      29980        1462.86
    1519.615 0.999414062500      29983        1706.67
    1577.983 0.999511718750      29986        2048.00
    1670.143 0.999560546875      29987        2275.56
    1738.751 0.999609375000      29989        2560.00
    1752.063 0.999658203125      29990        2925.71
    2068.479 0.999707031250      29992        3413.33
    2164.735 0.999755859375      29993        4096.00
    2543.615 0.999780273438      29994        4551.11
    2637.823 0.999804687500      29995        5120.00
    2637.823 0.999829101563      29995        5851.43
    2850.815 0.999853515625      29996        6826.67
    3092.479 0.999877929688      29997        8192.00
    3092.479 0.999890136719      29997        9102.22
    3776.511 0.999902343750      29998       10240.00
    3776.511 0.999914550781      29998       11702.86
    3776.511 0.999926757813      29998       13653.33
    4616.191 0.999938964844      29999       16384.00
    4616.191 0.999945068359      29999       18204.44
    4616.191 0.999951171875      29999       20480.00
    4616.191 0.999957275391      29999       23405.71
    4616.191 0.999963378906      29999       27306.67
    9568.255 0.999969482422      30000       32768.00
    9568.255 1.000000000000      30000
#[Mean    =      383.166, StdDeviation   =       91.478]
#[Max     =     9568.255, Total count    =        30000]
#[Buckets =           24, SubBuckets     =         2048]
```

#### COMPLETE_BATCH_HISTOGRAM

```
       Value     Percentile TotalCount 1/(1-Percentile)

      60.799 0.000000000000          1           1.00
      72.767 0.100000000000       3031           1.11
      77.951 0.200000000000       6040           1.25
      81.215 0.300000000000       9002           1.43
      83.903 0.400000000000      12068           1.67
      86.463 0.500000000000      15004           2.00
      87.935 0.550000000000      16561           2.22
      89.279 0.600000000000      18000           2.50
      90.943 0.650000000000      19561           2.86
      92.863 0.700000000000      21040           3.33
      95.295 0.750000000000      22526           4.00
      96.831 0.775000000000      23273           4.44
      98.495 0.800000000000      24020           5.00
     100.479 0.825000000000      24766           5.71
     102.975 0.850000000000      25512           6.67
     106.111 0.875000000000      26258           8.00
     108.159 0.887500000000      26626           8.89
     110.399 0.900000000000      27004          10.00
     113.343 0.912500000000      27377          11.43
     117.887 0.925000000000      27753          13.33
     124.671 0.937500000000      28125          16.00
     129.471 0.943750000000      28313          17.78
     135.679 0.950000000000      28501          20.00
     141.823 0.956250000000      28692          22.86
     148.863 0.962500000000      28876          26.67
     155.903 0.968750000000      29065          32.00
     161.151 0.971875000000      29158          35.56
     166.015 0.975000000000      29250          40.00
     173.311 0.978125000000      29344          45.71
     181.503 0.981250000000      29440          53.33
     191.359 0.984375000000      29533          64.00
     197.631 0.985937500000      29579          71.11
     204.799 0.987500000000      29625          80.00
     212.735 0.989062500000      29672          91.43
     222.975 0.990625000000      29719         106.67
     232.447 0.992187500000      29766         128.00
     237.823 0.992968750000      29790         142.22
     244.607 0.993750000000      29813         160.00
     255.103 0.994531250000      29836         182.86
     264.703 0.995312500000      29860         213.33
     278.015 0.996093750000      29883         256.00
     285.695 0.996484375000      29895         284.44
     296.191 0.996875000000      29907         320.00
     302.847 0.997265625000      29918         365.71
     321.023 0.997656250000      29930         426.67
     344.831 0.998046875000      29942         512.00
     365.567 0.998242187500      29948         568.89
     376.575 0.998437500000      29954         640.00
     412.159 0.998632812500      29959         731.43
     433.151 0.998828125000      29965         853.33
     487.679 0.999023437500      29971        1024.00
     502.271 0.999121093750      29974        1137.78
     510.207 0.999218750000      29977        1280.00
     522.495 0.999316406250      29980        1462.86
     548.351 0.999414062500      29984        1706.67
     607.231 0.999511718750      29986        2048.00
     659.967 0.999560546875      29987        2275.56
     809.471 0.999609375000      29989        2560.00
     845.823 0.999658203125      29990        2925.71
    1267.711 0.999707031250      29992        3413.33
    1915.903 0.999755859375      29993        4096.00
    2073.599 0.999780273438      29994        4551.11
    2650.111 0.999804687500      29995        5120.00
    2650.111 0.999829101563      29995        5851.43
    2662.399 0.999853515625      29996        6826.67
    2758.655 0.999877929688      29997        8192.00
    2758.655 0.999890136719      29997        9102.22
    3540.991 0.999902343750      29998       10240.00
    3540.991 0.999914550781      29998       11702.86
    3540.991 0.999926757813      29998       13653.33
   10846.207 0.999938964844      29999       16384.00
   10846.207 0.999945068359      29999       18204.44
   10846.207 0.999951171875      29999       20480.00
   10846.207 0.999957275391      29999       23405.71
   10846.207 0.999963378906      29999       27306.67
   13025.279 0.999969482422      30000       32768.00
   13025.279 1.000000000000      30000
#[Mean    =       93.701, StdDeviation   =      108.041]
#[Max     =    13025.279, Total count    =        30000]
#[Buckets =           24, SubBuckets     =         2048]
```
